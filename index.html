<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="color-scheme" content="light dark"/>
<meta name="description" content="Appli de L√©na ‚Äî activit√©s ludiques (lecture, maths, logique, arts) avec √©toiles, pi√®ces et effets magiques pour enfants."/>
<title>Appli de L√©na ‚Äî Menu magique ü¶Ñ</title>
<meta name="theme-color" content="#b06fff"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@600;700;900&family=Nunito:wght@600;800&display=swap" rel="stylesheet">
<style>
/* Estilos CSS del juego
  Mejoras de la paleta de colores, tipograf√≠a, y animaciones.
  Secci√≥n 'Memory Game' a√±adida.
*/

:root {
  /* Paleta de colores m√°s vibrante y pastel */
  --bg: #fdf6e3;
  --bg2: #fae6b8;
  --card: rgba(255, 255, 255, .95);
  --cardHi: rgba(255, 255, 255, .9);
  --ink: #4a4a4a;
  --muted: #8c8c8c;
  --primary: #9466ff;
  --primary-light: #b06fff;
  --success: #66bb6a;
  --warning: #ffb74d;
  --danger: #ef5350;
  --highlight: #ffee58;
  /* Espaciado y tipograf√≠a */
  --space-unit: 1rem;
  --font-heading: 'Fredoka', sans-serif;
  --font-body: 'Nunito', sans-serif;
  --font-size-base: 1rem;
  --font-size-large: 1.5rem;
  --font-size-xl: 2rem;
  --font-size-xxl: 3rem;
  /* Sombra y bordes */
  --shadow-small: 0 4px 6px rgba(0, 0, 0, 0.1);
  --shadow-medium: 0 10px 15px rgba(0, 0, 0, 0.15);
  --shadow-large: 0 20px 25px rgba(0, 0, 0, 0.2);
  --border-radius-large: 1.5rem;
  --border-radius-medium: 1rem;
}

* { box-sizing: border-box; }
body {
  font-family: var(--font-body);
  background: var(--bg);
  color: var(--ink);
  margin: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: var(--space-unit);
  line-height: 1.6;
  font-size: var(--font-size-base);
  transition: background-color 0.5s ease-in-out;
}

/* Fondos de pantalla por nivel */
.body-level-1 { background-color: #fce4ec; }
.body-level-2 { background-color: #e3f2fd; }
.body-level-3 { background-color: #e8f5e9; }
.body-level-4 { background-color: #fff3e0; }
.body-level-5 { background-color: #f3e5f5; }
.body-level-6 { background-color: #e0f2f1; }
.body-level-7 { background-color: #f1f8e9; }
.body-level-8 { background-color: #e1f5fe; }
.body-level-9 { background-color: #fffde7; }
.body-level-10 { background-color: #efebe9; }
.body-level-11 { background-color: #fce4ec; }
.body-level-12 { background-color: #e3f2fd; }


#stageTop {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  max-width: 800px;
  padding: var(--space-unit);
  font-family: var(--font-heading);
  font-size: var(--font-size-large);
  color: var(--primary);
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
  flex-wrap: wrap;
  gap: 1rem;
}

#stageTop .scores-container {
  display: flex;
  justify-content: space-between;
  width: 100%;
}

#stageTop span {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  background: var(--card);
  box-shadow: var(--shadow-small);
}

#stageTop span::before {
  content: '‚≠êÔ∏è';
  font-size: 1.25em;
}

#stageTop span.coins::before {
  content: 'üí∞';
}

#stageTop span.level::before {
  content: 'üöÄ';
}

/* Estilos mejorados para los botones de temas */
.topic-btn {
  font-family: var(--font-heading);
  padding: 1rem 1.5rem;
  border-radius: 1.5rem;
  border: none;
  background: var(--bg2);
  color: var(--primary);
  cursor: pointer;
  transition: all 0.2s ease-in-out;
  box-shadow: var(--shadow-small);
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  gap: 0.5rem;
  font-size: var(--font-size-large);
  animation: bounceIn 0.5s ease-out;
}
.topic-btn:hover {
  transform: scale(1.05);
  box-shadow: var(--shadow-medium);
  background: var(--primary-light);
  color: white;
}
.topic-btn:active {
  transform: scale(0.95);
  box-shadow: var(--shadow-small);
}

#btnBack {
  background: var(--muted);
  color: white;
  margin-top: 1rem;
  box-shadow: var(--shadow-small);
  transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}
#btnBack:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-medium);
}
#btnBack:active {
  transform: scale(0.95);
}

#stageBottom {
  width: 100%;
  max-width: 800px;
  background: var(--card);
  border-radius: var(--border-radius-large);
  padding: calc(var(--space-unit) * 2);
  box-shadow: var(--shadow-large);
  text-align: center;
  position: relative;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  gap: var(--space-unit);
  animation: fadeIn 1s ease-in-out;
}

#stageBottom::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, var(--p1) 0%, transparent 70%);
  opacity: 0.1;
  animation: bg-pulse 10s infinite alternate;
}

@keyframes bg-pulse {
  from { transform: scale(1); }
  to { transform: scale(1.1); }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

#content {
  position: relative;
  z-index: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--space-unit);
}

.question-prompt {
  font-family: var(--font-heading);
  font-size: var(--font-size-xl);
  color: var(--ink);
  margin-bottom: var(--space-unit);
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
  animation: fadeIn 0.8s ease-in-out;
}

.options-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--space-unit);
  width: 100%;
}

.option {
  font-family: var(--font-body);
  font-size: var(--font-size-large);
  padding: var(--space-unit);
  border-radius: var(--border-radius-medium);
  background: var(--bg2);
  border: 3px solid transparent;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
  box-shadow: var(--shadow-small);
  text-align: center;
  animation: bounceIn 0.5s ease-out;
}

.option:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-medium);
  border-color: var(--primary-light);
}
.option:active {
  transform: scale(0.95);
}

.option.selected {
  transform: scale(1.05);
  border-color: var(--primary);
  background: var(--primary);
  color: white;
  box-shadow: var(--shadow-medium);
}

.option.correct {
  transform: scale(1.1);
  background: var(--success);
  border-color: var(--success);
  color: white;
  animation: pop 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55) both;
}

.option.wrong {
  transform: scale(0.95);
  background: var(--danger);
  border-color: var(--danger);
  color: white;
  animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
}

.prompt {
  font-family: var(--font-heading);
  font-size: var(--font-size-large);
  margin-top: var(--space-unit);
  padding: 0.5rem 1rem;
  border-radius: 1rem;
  width: fit-content;
  align-self: center;
  animation: fadeIn 0.5s ease-in-out;
}

.prompt.ok {
  background-color: var(--success);
  color: white;
}

.prompt.bad {
  background-color: var(--danger);
  color: white;
}

#stageBtns {
  display: flex;
  justify-content: center;
  gap: var(--space-unit);
  margin-top: calc(var(--space-unit) * 2);
  width: 100%;
}

.btn {
  font-family: var(--font-heading);
  font-size: var(--font-size-large);
  padding: 0.75rem 2rem;
  border-radius: var(--border-radius-medium);
  border: none;
  cursor: pointer;
  box-shadow: var(--shadow-small);
  transition: all 0.2s ease-in-out;
  flex-grow: 1;
  max-width: 200px;
}

.btn:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-medium);
}
.btn:active {
  transform: scale(0.95);
}

#btnPrev {
  background: var(--muted);
  color: white;
}

#btnSkip {
  background: var(--primary-light);
  color: white;
}

/* Animaciones y efectos */
.fx-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
.fx-pop { animation: pop 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55) both; }
.fx-glow { animation: glow 1.5s infinite alternate; }
.fx-pop-out { animation: pop-out 0.5s forwards; }
.fx-bounce-menu { animation: bounceIn 0.5s ease-out; }

@keyframes shake {
  10%, 90% { transform: translate3d(-1px, 0, 0); }
  20%, 80% { transform: translate3d(2px, 0, 0); }
  30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
  40%, 60% { transform: translate3d(4px, 0, 0); }
}

@keyframes pop {
  0% { transform: scale(0); }
  100% { transform: scale(1); }
}

@keyframes pop-out {
  0% { opacity: 1; transform: scale(1); }
  100% { opacity: 0; transform: scale(1.2); }
}

@keyframes glow {
  from { box-shadow: 0 0 5px var(--success); }
  to { box-shadow: 0 0 20px var(--success), 0 0 30px var(--success); }
}

@keyframes sparkle {
  0% { opacity: 0; transform: scale(0.5); }
  50% { opacity: 0.4; transform: scale(1.2); }
  100% { opacity: 0; transform: scale(0.5); }
}

@keyframes bounceIn {
  0%, 20%, 40%, 60%, 80%, 100% {
    transition-timing-function: cubic-bezier(0.215, 0.610, 0.355, 1.000);
  }
  0% {
    opacity: 0;
    transform: scale3d(0.3, 0.3, 0.3);
  }
  20% {
    transform: scale3d(1.1, 1.1, 1.1);
  }
  40% {
    transform: scale3d(0.9, 0.9, 0.9);
  }
  60% {
    opacity: 1;
    transform: scale3d(1.03, 1.03, 1.03);
  }
  80% {
    transform: scale3d(0.97, 0.97, 0.97);
  }
  100% {
    opacity: 1;
    transform: scale3d(1, 1, 1);
  }
}

/* Media queries */
@media (max-width: 768px) {
  #stageBottom { padding: var(--space-unit); }
  .btn { padding: 0.75rem 1.5rem; font-size: 1rem; }
  .question-prompt { font-size: 1.5rem; }
  .options-grid { grid-template-columns: 1fr; }
}

/* Estilos para "Les maisons des nombres" */
.number-house-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: var(--bg2);
  border-radius: 2rem;
  box-shadow: var(--shadow-medium);
  width: 100%;
}
.rooftop {
  font-family: var(--font-heading);
  font-size: var(--font-size-xxl);
  background: var(--primary-light);
  color: white;
  padding: 0.5rem 1.5rem;
  border-radius: 1rem 1rem 0 0;
  box-shadow: var(--shadow-small);
}
.windows {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  width: 100%;
  padding: 1rem;
}
.window-row {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0.5rem;
  width: 100%;
}
.window-number, .window-input {
  font-family: var(--font-body);
  font-size: var(--font-size-large);
  background: white;
  padding: 0.75rem;
  border-radius: 0.5rem;
  box-shadow: var(--shadow-small);
  min-width: 60px;
  text-align: center;
  border: 2px solid transparent;
}
.window-number {
  background: var(--p2);
  color: var(--ink);
}
.window-input {
  background: var(--p3);
  border: 2px solid var(--p1);
  outline: none;
  transition: all 0.2s;
}
.window-input:focus {
  border-color: var(--primary-light);
  transform: scale(1.05);
}
.window-input.correct {
  border-color: var(--success);
  background: #e6ffec;
}
.window-input.incorrect {
  border-color: var(--danger);
  background: #ffe6e6;
}
.plus-sign, .equal-sign {
  font-family: var(--font-heading);
  font-size: var(--font-size-xl);
  color: var(--muted);
}
.submit-btn {
  font-family: var(--font-heading);
  font-size: var(--font-size-large);
  padding: 0.75rem 2rem;
  border-radius: 1rem;
  border: none;
  cursor: pointer;
  box-shadow: var(--shadow-small);
  background: var(--primary);
  color: white;
  transition: all 0.2s;
  margin-top: 1rem;
}

/* Estilos para "Les Couleurs" */
.color-option-button {
  padding: 0.75rem 1.5rem;
  border-radius: 1rem;
  border: none;
  cursor: pointer;
  box-shadow: var(--shadow-small);
  transition: all 0.2s ease-in-out;
  flex-grow: 1;
  max-width: 200px;
  font-size: var(--font-size-large);
  font-family: var(--font-body);
  color: white;
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
}
.color-option-button:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-medium);
}
/* Specific color classes */
.color-blue { background-color: #42a5f5; }
.color-yellow { background-color: #ffee58; color: var(--ink); }
.color-red { background-color: #ef5350; }
.color-green { background-color: #66bb6a; }
.color-orange { background-color: #ff9800; }
.color-purple { background-color: #ab47bc; }
.color-white { background-color: white; color: var(--ink); }
.color-black { background-color: black; }
.color-pink { background-color: #ec407a; }
.color-light-blue { background-color: #29b6f6; }
.color-light-green { background-color: #9ccc65; }

/* Estilos para "Contes Magiques" */
.story-container {
  text-align: left;
  position: relative;
}
.story-container h2 {
  font-family: var(--font-heading);
  color: var(--primary);
  text-align: center;
}
.story-container img {
  max-width: 100%;
  height: auto;
  border-radius: 1rem;
  margin-bottom: 1rem;
}
.sparkle {
  animation: sparkle 2s ease-in-out infinite;
  position: absolute;
  font-size: 2rem;
  z-index: 10;
  pointer-events: none;
  opacity: 0;
}

/* Estilos para "M√©moire Magique" */
.memory-grid {
    display: grid;
    gap: 10px;
    width: 100%;
    max-width: 500px;
}
.memory-card {
    background-color: var(--primary);
    border-radius: 10px;
    height: 100px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 2rem;
    cursor: pointer;
    transform: rotateY(180deg);
    transition: transform 0.6s;
    box-shadow: var(--shadow-small);
}
.memory-card.flipped {
    transform: rotateY(0deg);
    background-color: var(--card);
}
.memory-card.matched {
    cursor: default;
    background-color: var(--success);
    transition: background-color 0.5s;
    pointer-events: none;
}
.memory-card.disabled {
    pointer-events: none;
}
</style>
</head>
<body class="body-level-1">
  <div id="stageTop">
    <div class="scores-container">
      <span id="scoreStars">0</span>
      <span id="scoreCoins" class="coins">0</span>
      <span id="level" class="level">Niveau 1</span>
    </div>
    <button id="btnBack" class="btn">Retourner</button>
  </div>

  <div id="stageBottom">
    <div id="content">
    </div>
    
    <div id="stageBtns">
      <button id="btnPrev" class="btn" aria-label="Pr√©c√©dent">Pr√©c√©dent</button>
      <button id="btnSkip" class="btn" aria-label="Passer">Passer</button>
    </div>
  </div>

  <audio id="audioCorrect" src="https://assets.mixkit.co/sfx/download/mixkit-game-bling-2041.wav"></audio>
  <audio id="audioWrong" src="https://assets.mixkit.co/sfx/download/mixkit-wrong-answer-2051.wav"></audio>

  <script src="https://cdn.jsdelivr.net/npm/tsparticles-confetti@2.12.0/tsparticles.confetti.bundle.min.js"></script>
  <script>
    // Configuraci√≥n global del juego
    const LEVELS_PER_TOPIC = 12;
    const QUESTIONS_PER_LEVEL = 5;
    const HOUSE_PAIRS_PER_LEVEL = 10;
    const MEMORY_GAME_LEVELS = [
      { level: 1, pairs: 2, grid: '2x2' },
      { level: 2, pairs: 4, grid: '2x4' },
      { level: 3, pairs: 6, grid: '3x4' },
      { level: 4, pairs: 8, grid: '4x4' }
    ];
    
    // Emojis y recursos
    const emoji = {
        blue: 'üîµ', yellow: 'üü°', red: 'üî¥', green: 'üü¢', orange: 'üü†', purple: 'üü£',
        car: 'üöó', bus: 'üöå', plane: '‚úàÔ∏è', rocket: 'üöÄ', star: '‚≠ê', coin: 'üí∞', sparkle: '‚ú®',
        bear: 'üêª', rabbit: 'üê∞', dog: 'üê∂', cat: 'üê±', fish: 'üê†', frog: 'üê∏', bird: 'üê¶', panda: 'üêº'
    };
    
    // Contenido del juego
    const positiveMessages = ['ü¶Ñ Bravo !', '‚ú® Super !', 'üåà G√©nial !', 'üåü Parfait !'];
    const magicStories = [
      {
          title: "Le Voyage de L√©na l'√âtoile",
          image: "https://via.placeholder.com/600x400.png?text=Le+voyage+de+Lena",
          text: ["L√©na √©tait une toute petite √©toile, brillante comme un diamant. Elle vivait sur une montagne magique avec sa petite s≈ìur Yaya.", "Un jour, L√©na d√©cida de faire un grand voyage pour trouver le plus beau des arcs-en-ciel. Yaya, tr√®s curieuse, la rejoignit. Elles saut√®rent de nuage en nuage. C'√©tait un jeu tr√®s amusant !", "Finalement, elles trouv√®rent un arc-en-ciel g√©ant. C'√©tait le plus beau de tous. Mission accomplie ! L√©na et Yaya avaient fait un voyage inoubliable."],
          quiz: [
            { question: "Qui est L√©na ?", options: ["Une princesse", "Une √©toile", "Un animal"], correct: 1 },
            { question: "O√π vivait L√©na ?", options: ["Dans une for√™t", "Sur une montagne magique", "Dans un ch√¢teau"], correct: 1 },
            { question: "Qu'ont-elles trouv√© √† la fin de leur voyage ?", options: ["Une fleur", "Un tr√©sor", "Un arc-en-ciel"], correct: 2 }
          ]
      },
      {
          title: "Le Lion au Grand Coeur",
          image: "https://via.placeholder.com/600x400.png?text=Le+lion+au+grand+coeur",
          text: ["Dans la savane vivait un lion nomm√© L√©o. Il n'√©tait pas le plus fort, mais il √©tait le plus courageux et le plus gentil. L√©na et Yaya √©taient ses meilleures amies.", "Un jour, une petite antilope se retrouva coinc√©e dans un mar√©cage. L√©na et Yaya √©taient inqui√®tes. L√©o, sans h√©siter, sauta dans la boue pour la sauver.", "Les autres animaux applaudirent. L√©o avait montr√© que le courage ne se mesure pas √† la force, mais √† la gentillesse. L√©na et Yaya √©taient si fi√®res de leur ami."],
          quiz: [
            { question: "Comment s'appelle le lion ?", options: ["L√©o", "Max", "Simba"], correct: 0 },
            { question: "Qu'est-ce qui le rendait courageux ?", options: ["Sa force", "Sa gentillesse", "Sa vitesse"], correct: 1 },
            { question: "Quel animal L√©o a-t-il sauv√© ?", options: ["Un z√®bre", "Une antilope", "Une girafe"], correct: 1 }
          ]
      },
      {
          title: "Le Petit Nuage Heureux",
          image: "https://via.placeholder.com/600x400.png?text=Le+petit+nuage+heureux",
          text: ["C'√©tait une journ√©e triste. Le soleil √©tait cach√© derri√®re de gros nuages gris. L√©na et Yaya cherchaient des couleurs. Mais parmi eux, il y avait un petit nuage blanc et joyeux nomm√© Fluffy. Fluffy voulait rendre les enfants heureux.", "Il vit une petite fille qui pleurait car elle n'avait pas de parapluie. Fluffy d√©cida de se transformer en un arc-en-ciel. Il s'√©tira et changea de couleurs, illuminant le ciel. L√©na et Yaya √©taient √©merveill√©es !", "La petite fille leva les yeux, sourit et se mit √† rire. Fluffy √©tait si fier. Il avait compris que partager sa joie √©tait la plus belle des choses, et L√©na et Yaya l'avaient aid√© en partageant leur bonheur."],
          quiz: [
            { question: "Comment s'appelle le petit nuage ?", options: ["Fluffy", "Coco", "Grisou"], correct: 0 },
            { question: "En quoi s'est-il transform√© ?", options: ["Un √©clair", "Un arc-en-ciel", "De la pluie"], correct: 1 },
            { question: "Quelle le√ßon a-t-il apprise ?", options: ["√ätre triste", "Partager sa joie", "Rester immobile"], correct: 1 }
          ]
      },
      {
          title: "Le Ch√™ne et la F√©e",
          image: "https://via.placeholder.com/600x400.png?text=Le+chene+et+la+fee",
          text: ["Dans une for√™t ancienne vivait un vieux ch√™ne sage. L√©na, la jeune f√©e, voulait devenir la gardienne de la for√™t. Yaya, sa petite s≈ìur, voulait l'aider. Le ch√™ne leur enseigna les secrets de la nature, un par un.", "Chaque jour, L√©na et Yaya √©tudiaient les plantes, les rivi√®res et les animaux. C'√©tait difficile et long. Parfois, elles voulaient abandonner. Mais le ch√™ne leur dit: 'La connaissance ne se cueille pas, elle se cultive. Soyez patientes.'", "Des ann√©es plus tard, L√©na devint la f√©e la plus sage de la for√™t. Elle avait compris que l'√©tude et la patience √©taient les cl√©s pour atteindre ses r√™ves. Yaya √©tait sa meilleure alli√©e. Leur amour pour la for√™t √©tait leur plus grande force."],
          quiz: [
            { question: "Qui est L√©na ?", options: ["Un ch√™ne", "Une f√©e", "Une princesse"], correct: 1 },
            { question: "Qui leur a enseign√© les secrets de la nature ?", options: ["Le vieux ch√™ne", "Un oiseau", "Le vent"], correct: 0 },
            { question: "Quelle a √©t√© leur plus grande le√ßon ?", options: ["La force et la rapidit√©", "La connaissance et la patience", "La magie et la col√®re"], correct: 1 }
          ]
      }
    ];

    const colorMap = {
        'üü¢ Vert': 'green', 'üü† Orange': 'orange', 'üü£ Violet': 'purple',
        'üîµ Bleu': 'blue', 'üü° Jaune': 'yellow', 'üî¥ Rouge': 'red',
        '‚ö´ Noir': 'black', '‚ö™ Blanc': 'white', 'üíó Rose': 'pink',
        'üíß Bleu Clair': 'light-blue', 'üçÉ Vert Clair': 'light-green',
        '‚ö™ Blanc + üî¥ Rouge': 'pink', 'üîµ Bleu + üü° Jaune': 'green', 'üî¥ Rouge + üü° Jaune': 'orange', 'üîµ Bleu + üî¥ Rouge': 'purple',
    };
    
    // Elementos del DOM
    const content = document.getElementById('content');
    const btnBack = document.getElementById('btnBack');
    const scoreStars = document.getElementById('scoreStars');
    const scoreCoins = document.getElementById('scoreCoins');
    const levelDisplay = document.getElementById('level');
    const audioCorrect = document.getElementById('audioCorrect');
    const audioWrong = document.getElementById('audioWrong');
    
    let currentTopic = '';
    let currentLevel = 1;
    let currentQuestionIndex = 0;
    let userScore = { stars: 0, coins: 0 };
    let answeredQuestions = {};
    let storyQuiz = [];
    
    // Base de datos de preguntas generadas din√°micamente
    const allQuestions = {
        additions: [], soustractions: [], multiplications: [], colors: [], stories: []
    };
    
    /* === Funciones Auxiliares === */
    function speakText(text) {
        if (window.speechSynthesis) {
            const synth = window.speechSynthesis;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'fr-FR';
            synth.speak(utterance);
        }
    }
    
    function playSound(type) {
        if (type === 'correct') {
            audioCorrect.currentTime = 0;
            audioCorrect.play();
        } else if (type === 'wrong') {
            audioWrong.currentTime = 0;
            audioWrong.play();
        }
    }

    function shuffle(array) {
        return array.sort(() => Math.random() - 0.5);
    }
    
    function updateUI() {
        scoreStars.textContent = userScore.stars;
        scoreCoins.textContent = userScore.coins;
        levelDisplay.textContent = `Niveau ${currentLevel}`;
        document.body.className = `body-level-${currentLevel}`;
    }
    
    function showSuccessMessage(message = positiveMessages[Math.floor(Math.random() * positiveMessages.length)]) {
        const promptEl = document.createElement('div');
        promptEl.className = 'prompt ok';
        promptEl.textContent = message;
        content.appendChild(promptEl);
        speakText(message);
        playSound('correct');
        setTimeout(() => promptEl.remove(), 1000);
    }
    
    function showErrorMessage(message = 'R√©ponse incorrecte.') {
        const promptEl = document.createElement('div');
        promptEl.className = 'prompt bad fx-shake';
        promptEl.textContent = message;
        content.appendChild(promptEl);
        speakText(message);
        playSound('wrong');
        setTimeout(() => promptEl.remove(), 1000);
    }

    function showConfetti() {
        confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 }
        });
    }

    /* === Generaci√≥n de Contenido === */
    function generateMathQuestion(type, level) {
        let num1, num2, correct, max;
        const rewards = { additions: 10, soustractions: 10, multiplications: 15 };

        // Ajuste de dificultad seg√∫n los requisitos
        if (level === 1) max = 10;
        else if (level === 2) max = 20;
        else if (level === 3) max = 50;
        else max = 100;

        switch(type) {
            case 'additions':
                num1 = Math.floor(Math.random() * (max - 1)) + 1;
                num2 = Math.floor(Math.random() * (max - num1)) + 1;
                correct = num1 + num2;
                break;
            case 'soustractions':
                num1 = Math.floor(Math.random() * (max - 1)) + 10;
                num2 = Math.floor(Math.random() * num1);
                correct = num1 - num2;
                break;
            case 'multiplications':
                if (level <= 4) { // Tablas del 1 al 5
                    num1 = Math.floor(Math.random() * 5) + 1;
                    num2 = Math.floor(Math.random() * 10) + 1;
                } else if (level <= 8) { // Tablas del 6 al 10
                    num1 = Math.floor(Math.random() * 5) + 6;
                    num2 = Math.floor(Math.random() * 10) + 1;
                } else { // Mixtas
                    num1 = Math.floor(Math.random() * 10) + 1;
                    num2 = Math.floor(Math.random() * 10) + 1;
                }
                correct = num1 * num2;
                break;
        }

        const options = shuffle([correct, correct + 1, correct - 1, correct + 2].filter(n => n >= 0 && n !== correct).slice(0, 3).concat(correct));
        return {
            questionText: `Combien font ${num1} ${type === 'additions' ? '+' : type === 'soustractions' ? '-' : 'x'} ${num2}?`,
            options: options,
            correct: options.indexOf(correct),
            difficulty: level,
            reward: { stars: level * rewards[type], coins: level * (rewards[type] / 2) }
        };
    }
    
    function generateColorQuestion(level) {
        let questionData = {};
        const allColors = Object.keys(colorMap);
        const primaryColors = ['üîµ Bleu', 'üü° Jaune', 'üî¥ Rouge'];
        const secondaryColors = ['üü¢ Vert', 'üü† Orange', 'üü£ Violet'];
        
        if (level <= 3) { // Colores primarios
            const color = shuffle(primaryColors)[0];
            questionData = { questionText: `Quelle est la couleur ${color}?`, correct: color };
        } else if (level <= 6) { // Colores secundarios
            const combinations = shuffle([
                { text: `üîµ Bleu + üü° Jaune`, result: 'üü¢ Vert' },
                { text: `üî¥ Rouge + üü° Jaune`, result: 'üü† Orange' },
                { text: `üîµ Bleu + üî¥ Rouge`, result: 'üü£ Violet' }
            ]);
            const combo = combinations[0];
            questionData = { questionText: `Quelle couleur obtient-on en m√©langeant ${combo.text}?`, correct: combo.result };
        } else { // Combinaciones abstractas/avanzadas
            const color = shuffle(allColors.filter(c => !primaryColors.includes(c) && !secondaryColors.includes(c)))[0];
            questionData = { questionText: `Quelle couleur est ${color}?`, correct: color };
        }

        let options = [questionData.correct];
        while (options.length < 4) {
            const randomColor = shuffle(allColors)[0];
            if (!options.includes(randomColor)) {
                options.push(randomColor);
            }
        }
        questionData.options = shuffle(options);
        questionData.correct = questionData.options.indexOf(questionData.correct);
        return { ...questionData, difficulty: level, reward: { stars: 20, coins: 15 } };
    }

    function initializeQuestions() {
        // Generar 12 niveles para cada categor√≠a
        for (let level = 1; level <= LEVELS_PER_TOPIC; level++) {
            for (let i = 0; i < QUESTIONS_PER_LEVEL; i++) {
                allQuestions.additions.push(generateMathQuestion('additions', level));
                allQuestions.soustractions.push(generateMathQuestion('soustractions', level));
                allQuestions.multiplications.push(generateMathQuestion('multiplications', level));
                allQuestions.colors.push(generateColorQuestion(level));
            }
        }
    }

    /* === Gesti√≥n de pantallas === */
    function showTopicMenu() {
        content.innerHTML = '';
        const prompt = document.createElement('div');
        prompt.className = 'question-prompt fx-bounce-menu';
        prompt.textContent = 'S√©lectionne un sujet pour commencer.';
        content.appendChild(prompt);
        speakText('S√©lectionne un sujet pour commencer.');

        const topicsContainer = document.createElement('div');
        topicsContainer.className = 'options-grid';
        
        const allTopics = [
            { id: 'additions', text: '‚ûï Additions' },
            { id: 'soustractions', text: '‚ûñ Soustractions' },
            { id: 'multiplications', text: '‚úñÔ∏è Multiplications' },
            { id: 'number-houses', text: 'üè† Maisons des Nombres' },
            { id: 'colors', text: 'üé® Les Couleurs' },
            { id: 'stories', text: 'üìö Contes Magiques' },
            { id: 'memory', text: 'üß† M√©moire Magique' }
        ];

        allTopics.forEach(topic => {
            const btn = document.createElement('button');
            btn.className = 'topic-btn';
            btn.innerHTML = topic.text;
            btn.dataset.topic = topic.id;
            btn.addEventListener('click', () => {
                currentTopic = topic.id;
                if (topic.id === 'stories') { showStoryMenu(); }
                else if (topic.id === 'memory') { showMemoryGameMenu(); }
                else { showLevelMenu(topic.id); }
            });
            topicsContainer.appendChild(btn);
        });
        content.appendChild(topicsContainer);

        btnBack.style.display = 'none';
        document.body.className = `body-level-1`;
    }

    function showLevelMenu(topic) {
        currentTopic = topic;
        content.innerHTML = '';
        const title = document.createElement('div');
        title.className = 'question-prompt';
        title.textContent = `Choisis un niveau pour ${topic}`;
        content.appendChild(title);
        speakText(`Choisis un niveau pour ${topic}`);

        const levelsContainer = document.createElement('div');
        levelsContainer.className = 'options-grid';

        for (let i = 1; i <= LEVELS_PER_TOPIC; i++) {
            const levelBtn = document.createElement('div');
            levelBtn.className = 'option level-btn';
            levelBtn.textContent = `Niveau ${i}`;
            if (answeredQuestions[`${currentTopic}-${i}`] === 'completed') {
                levelBtn.classList.add('correct');
            }
            levelBtn.addEventListener('click', () => {
                currentLevel = i;
                if (currentTopic === 'number-houses') { showNumberHousesGame(currentLevel); }
                else if (currentTopic === 'colors') { showColorGame(currentLevel); }
                else { currentQuestionIndex = 0; loadQuestion(0); }
            });
            levelsContainer.appendChild(levelBtn);
        }
        content.appendChild(levelsContainer);
        btnBack.style.display = 'inline-block';
        btnBack.textContent = 'Retour aux sujets';
        btnBack.onclick = showTopicMenu;
    }
    
    function handleOptionClick(event) {
        const selected = event.target;
        const options = document.querySelectorAll('.option');
        options.forEach(opt => opt.removeEventListener('click', handleOptionClick));
        
        const questionsForLevel = allQuestions[currentTopic].filter(q => q.difficulty === currentLevel);
        const questionData = questionsForLevel[currentQuestionIndex];
        
        const userAnswerIndex = parseInt(selected.dataset.index, 10);
        const correctAnswerIndex = questionData.correct;

        if (userAnswerIndex === correctAnswerIndex) {
            selected.classList.add('correct');
            userScore.stars += questionData.reward.stars;
            userScore.coins += questionData.reward.coins;
            showSuccessMessage();
            showConfetti();
        } else {
            selected.classList.add('wrong');
            userScore.coins = Math.max(0, userScore.coins - 5);
            const correctOption = document.querySelector(`.option[data-index="${correctAnswerIndex}"]`);
            if (correctOption) {
                correctOption.classList.add('correct');
            }
            showErrorMessage(`‚ùå -5 pi√®ces.`);
        }
        updateUI();

        setTimeout(() => {
            currentQuestionIndex++;
            if (currentQuestionIndex < QUESTIONS_PER_LEVEL) {
                loadQuestion(currentQuestionIndex);
            } else {
                answeredQuestions[`${currentTopic}-${currentLevel}`] = 'completed';
                const winPrompt = document.createElement('div');
                winPrompt.className = 'prompt ok';
                winPrompt.textContent = `Bravo, tu as compl√©t√© le Niveau ${currentLevel} !`;
                content.appendChild(winPrompt);
                speakText(`Bravo, tu as compl√©t√© le Niveau ${currentLevel} !`);
                setTimeout(() => showLevelMenu(currentTopic), 2000);
            }
        }, 2500);
    }
    
    function loadQuestion(index) {
        currentQuestionIndex = index;
        content.innerHTML = '';
        updateUI();

        const questionsForLevel = allQuestions[currentTopic].filter(q => q.difficulty === currentLevel);
        const questionData = questionsForLevel[index];
        const fragment = document.createDocumentFragment();

        const title = document.createElement('div');
        title.className = 'question-prompt';
        title.innerHTML = questionData.questionText;
        fragment.appendChild(title);
        speakText(questionData.questionText);

        const optionsContainer = document.createElement('div');
        optionsContainer.className = 'options-grid';
        
        const shuffledOptions = shuffle([...questionData.options]);
        shuffledOptions.forEach((opt, i) => {
            const optionEl = document.createElement('div');
            optionEl.className = 'option';
            optionEl.innerHTML = opt;
            const originalIndex = questionData.options.indexOf(opt);
            optionEl.dataset.index = originalIndex;
            optionEl.addEventListener('click', handleOptionClick);
            optionsContainer.appendChild(optionEl);
        });
        fragment.appendChild(optionsContainer);
        content.appendChild(fragment);

        btnBack.style.display = 'inline-block';
        btnBack.textContent = 'Retour aux niveaux';
        btnBack.onclick = () => showLevelMenu(currentTopic);
    }
    
    /* === Juegos Espec√≠ficos === */
    function showNumberHousesGame(level) {
        currentLevel = level;
        content.innerHTML = '';
        updateUI();
        
        const roofNumber = level + 10;
        const pairs = generateNumberPairs(roofNumber, HOUSE_PAIRS_PER_LEVEL);
        
        const houseHtml = `
            <div class="number-house-container">
                <div class="rooftop">${roofNumber}</div>
                <p>Compl√®te les maisons des nombres.</p>
                <div class="windows">
                    ${pairs.map(pair => `
                        <div class="window-row">
                            <span class="window-number">${pair[0]}</span>
                            <span class="plus-sign">+</span>
                            <input type="number" class="window-input" data-correct-value="${pair[1]}" />
                            <span class="equal-sign">=</span>
                            <span class="window-number">${roofNumber}</span>
                        </div>
                    `).join('')}
                </div>
                <button id="checkHouseBtn" class="submit-btn" aria-label="V√©rifier les r√©ponses">V√©rifier</button>
            </div>
        `;
        content.innerHTML = houseHtml;
        speakText("Compl√®te les maisons des nombres. √âcris le r√©sultat.");
        btnBack.style.display = 'inline-block';
        btnBack.textContent = 'Retour aux niveaux';
        btnBack.onclick = () => showLevelMenu(currentTopic);

        document.getElementById('checkHouseBtn').addEventListener('click', () => {
            const allInputs = document.querySelectorAll('.window-input');
            let allCorrect = true;
            let correctCount = 0;
            
            allInputs.forEach(input => {
                const inputValue = parseInt(input.value, 10);
                const correctValue = parseInt(input.dataset.correctValue, 10);
                if (inputValue === correctValue) {
                    input.classList.add('correct');
                    input.disabled = true;
                    correctCount++;
                } else {
                    input.classList.add('incorrect', 'fx-shake');
                    setTimeout(() => input.classList.remove('incorrect', 'fx-shake'), 1000);
                    userScore.coins = Math.max(0, userScore.coins - 5);
                    allCorrect = false;
                }
            });
            updateUI();
            if (allCorrect) {
                userScore.stars += 50; userScore.coins += 50;
                answeredQuestions[`${currentTopic}-${currentLevel}`] = 'completed';
                showSuccessMessage('Bravo ü¶Ñ‚ú® !');
                showConfetti();
                document.getElementById('checkHouseBtn').textContent = 'Niveau suivant';
                document.getElementById('checkHouseBtn').onclick = () => {
                  if (currentLevel < LEVELS_PER_TOPIC) { showNumberHousesGame(currentLevel + 1); }
                  else { win(); }
                };
            } else {
                showErrorMessage(`${correctCount} bonnes r√©ponses. -5 pi√®ces.`);
            }
        });
    }

    function generateNumberPairs(sum, count) {
        const pairs = new Set();
        while (pairs.size < count) {
            const num1 = Math.floor(Math.random() * (sum));
            const num2 = sum - num1;
            if (num1 >= 0 && num2 >= 0) {
                const pairString = [num1, num2].sort((a, b) => a - b).join('-');
                pairs.add(pairString);
            }
        }
        return Array.from(pairs).map(pair => pair.split('-').map(Number)).map(pair => shuffle(pair));
    }

    function showColorGame(level) {
        currentTopic = 'colors';
        currentLevel = level;
        currentQuestionIndex = 0;
        loadColorQuestion(0);
    }
    
    function loadColorQuestion(index) {
        currentQuestionIndex = index;
        content.innerHTML = '';
        updateUI();
        
        const questionsForLevel = allQuestions.colors.filter(q => q.difficulty === currentLevel);
        const questionData = questionsForLevel[index];
        const fragment = document.createDocumentFragment();
        
        const title = document.createElement('div');
        title.className = 'question-prompt';
        title.innerHTML = questionData.questionText;
        fragment.appendChild(title);
        speakText(questionData.questionText);

        const optionsContainer = document.createElement('div');
        optionsContainer.className = 'options-grid';
        
        const shuffledOptions = shuffle([...questionData.options]);
        shuffledOptions.forEach((opt, i) => {
            const optionEl = document.createElement('button');
            optionEl.className = 'color-option-button';
            const colorName = colorMap[opt];
            if (colorName) { optionEl.classList.add(`color-${colorName}`); }
            optionEl.innerHTML = opt;
            const originalIndex = questionData.options.indexOf(opt);
            optionEl.dataset.index = originalIndex;
            optionEl.addEventListener('click', handleColorOptionClick);
            optionsContainer.appendChild(optionEl);
        });
        fragment.appendChild(optionsContainer);
        content.appendChild(fragment);

        btnBack.style.display = 'inline-block';
        btnBack.textContent = 'Retour aux niveaux';
        btnBack.onclick = () => showLevelMenu(currentTopic);
    }
    
    function handleColorOptionClick(event) {
        const selected = event.target;
        const options = document.querySelectorAll('.color-option-button');
        options.forEach(opt => opt.removeEventListener('click', handleColorOptionClick));
        
        const questionsForLevel = allQuestions.colors.filter(q => q.difficulty === currentLevel);
        const questionData = questionsForLevel[currentQuestionIndex];
        const userAnswerIndex = parseInt(selected.dataset.index, 10);
        const correctAnswerIndex = questionData.correct;

        if (userAnswerIndex === correctAnswerIndex) {
            selected.classList.add('correct');
            userScore.stars += questionData.reward.stars;
            userScore.coins += questionData.reward.coins;
            showSuccessMessage();
            showConfetti();
        } else {
            selected.classList.add('wrong');
            userScore.coins = Math.max(0, userScore.coins - 5);
            const correctOption = document.querySelector(`.color-option-button[data-index="${correctAnswerIndex}"]`);
            if (correctOption) { correctOption.classList.add('correct'); }
            showErrorMessage(`‚ùå -5 pi√®ces.`);
        }
        updateUI();
        setTimeout(() => {
            currentQuestionIndex++;
            if (currentQuestionIndex < QUESTIONS_PER_LEVEL) {
                loadColorQuestion(currentQuestionIndex);
            } else {
                answeredQuestions[`${currentTopic}-${currentLevel}`] = 'completed';
                showSuccessMessage(`Bravo, tu as compl√©t√© le Niveau ${currentLevel} !`);
                setTimeout(() => showLevelMenu(currentTopic), 2000);
            }
        }, 2500);
    }

    function showStoryMenu() {
        content.innerHTML = '';
        const title = document.createElement('div');
        title.className = 'question-prompt';
        title.textContent = 'Choisis un conte magique ‚ú®';
        content.appendChild(title);
        speakText('Choisis un conte magique');
        
        const storiesContainer = document.createElement('div');
        storiesContainer.className = 'options-grid';
        
        magicStories.forEach((story, index) => {
            const storyBtn = document.createElement('button');
            storyBtn.className = 'topic-btn';
            storyBtn.innerHTML = `üìö ${story.title}`;
            storyBtn.addEventListener('click', () => showMagicStory(index));
            storiesContainer.appendChild(storyBtn);
        });
        
        content.appendChild(storiesContainer);
        btnBack.style.display = 'inline-block';
        btnBack.textContent = 'Retour aux sujets';
        btnBack.onclick = showTopicMenu;
    }

    function showMagicStory(storyIndex) {
        content.innerHTML = '';
        const story = magicStories[storyIndex];
        const storyContainer = document.createElement('div');
        storyContainer.className = 'story-container';
        storyContainer.innerHTML = `<h2>${story.title}</h2><img src="${story.image}" alt="${story.title}" />`;
        
        story.text.forEach(paragraph => {
            const p = document.createElement('p');
            p.textContent = paragraph;
            storyContainer.appendChild(p);
        });
        
        for(let i = 0; i < 5; i++) {
          const sparkle = document.createElement('span');
          sparkle.className = 'sparkle';
          sparkle.textContent = '‚ú®';
          sparkle.style.top = `${Math.random() * 100}%`;
          sparkle.style.left = `${Math.random() * 100}%`;
          sparkle.style.animationDelay = `${Math.random() * 2}s`;
          storyContainer.appendChild(sparkle);
        }

        const startQuizBtn = document.createElement('button');
        startQuizBtn.className = 'btn submit-btn';
        startQuizBtn.textContent = 'Commencer le quiz';
        startQuizBtn.style.marginTop = '2rem';
        startQuizBtn.addEventListener('click', () => startStoryQuiz(story.quiz));
        
        content.appendChild(storyContainer);
        content.appendChild(startQuizBtn);
        
        btnBack.style.display = 'inline-block';
        btnBack.textContent = 'Retour aux contes';
        btnBack.onclick = showStoryMenu;
        
        const fullStoryText = story.text.join(' ');
        speakText(story.title + '. ' + fullStoryText);
    }
    
    function startStoryQuiz(quizQuestions) {
        storyQuiz = quizQuestions;
        currentQuestionIndex = 0;
        loadQuizQuestion();
    }
    
    function loadQuizQuestion() {
        if (currentQuestionIndex >= storyQuiz.length) {
            showQuizResults();
            return;
        }
        
        content.innerHTML = '';
        const questionData = storyQuiz[currentQuestionIndex];
        const fragment = document.createDocumentFragment();
        
        const title = document.createElement('div');
        title.className = 'question-prompt';
        title.innerHTML = `Question ${currentQuestionIndex + 1}:<br>${questionData.question}`;
        fragment.appendChild(title);
        speakText(questionData.question);
        
        const optionsContainer = document.createElement('div');
        optionsContainer.className = 'options-grid';
        
        const shuffledOptions = shuffle([...questionData.options]);
        shuffledOptions.forEach((opt, i) => {
            const optionEl = document.createElement('button');
            optionEl.className = 'option';
            optionEl.innerHTML = opt;
            const originalIndex = questionData.options.indexOf(opt);
            optionEl.dataset.index = originalIndex;
            optionEl.addEventListener('click', handleStoryQuizAnswer);
            optionsContainer.appendChild(optionEl);
        });
        fragment.appendChild(optionsContainer);
        content.appendChild(fragment);

        btnBack.textContent = 'Retour au menu des contes';
        btnBack.onclick = showStoryMenu;
    }
    
    function handleStoryQuizAnswer(event) {
        const selected = event.target;
        const options = document.querySelectorAll('.option');
        options.forEach(opt => opt.removeEventListener('click', handleStoryQuizAnswer));
        
        const questionData = storyQuiz[currentQuestionIndex];
        const userAnswerIndex = parseInt(selected.dataset.index, 10);
        const correctAnswerIndex = questionData.correct;

        if (userAnswerIndex === correctAnswerIndex) {
            selected.classList.add('correct');
            userScore.stars += 15;
            userScore.coins += 10;
            showSuccessMessage('Bonne r√©ponse !');
            showConfetti();
        } else {
            selected.classList.add('wrong');
            userScore.coins = Math.max(0, userScore.coins - 5);
            const correctOption = document.querySelector(`.option[data-index="${correctAnswerIndex}"]`);
            if (correctOption) {
                correctOption.classList.add('correct');
            }
            showErrorMessage('Mauvaise r√©ponse.');
        }
        updateUI();
        
        setTimeout(() => {
            currentQuestionIndex++;
            loadQuizQuestion();
        }, 2000);
    }
    
    function showQuizResults() {
        content.innerHTML = `
            <div class="prompt ok">
                Quiz termin√© ! üéâ
                <p>Tu as gagn√© des √©toiles et des pi√®ces !</p>
            </div>
            <button class="btn submit-btn" onclick="showStoryMenu()">Retourner aux contes</button>
        `;
        speakText('Quiz termin√© ! Bravo !');
        btnBack.textContent = 'Retourner au Menu Principal';
        btnBack.onclick = showTopicMenu;
    }


    function showMemoryGameMenu() {
      content.innerHTML = `
        <div class="question-prompt">
          Choisis un niveau de m√©moire
        </div>
        <div class="options-grid">
          ${MEMORY_GAME_LEVELS.map(level => `
            <button class="topic-btn" onclick="showMemoryGame(${level.pairs})">
              Niveau ${level.level}<br>
              ${level.pairs} paires
            </button>
          `).join('')}
        </div>
      `;
      btnBack.style.display = 'inline-block';
      btnBack.textContent = 'Retour aux sujets';
      btnBack.onclick = showTopicMenu;
    }

    function showMemoryGame(pairsCount) {
        content.innerHTML = '';
        const title = document.createElement('div');
        title.className = 'question-prompt';
        title.textContent = 'Trouve toutes les paires !';
        content.appendChild(title);
        speakText('Trouve toutes les paires !');

        const memoryGrid = document.createElement('div');
        memoryGrid.className = 'memory-grid';
        const levelConfig = MEMORY_GAME_LEVELS.find(l => l.pairs === pairsCount);
        if (levelConfig) {
          memoryGrid.style.gridTemplateColumns = `repeat(${Math.sqrt(pairsCount*2)}, 1fr)`;
        }
        content.appendChild(memoryGrid);

        const cardEmojis = Object.values(emoji).slice(6, 6 + pairsCount);
        const gameCards = shuffle([...cardEmojis, ...cardEmojis]);
        let flippedCards = [];
        let matchedPairs = 0;
        let lockBoard = false;

        gameCards.forEach((emoji, index) => {
            const card = document.createElement('div');
            card.className = 'memory-card';
            card.innerHTML = `<span style="opacity:0;">${emoji}</span>`;
            card.addEventListener('click', () => flipCard(card, emoji, index));
            memoryGrid.appendChild(card);
        });

        function flipCard(card, emoji, index) {
            if (lockBoard) return;
            if (card.classList.contains('flipped')) return;

            card.classList.add('flipped');
            card.querySelector('span').style.opacity = '1';
            flippedCards.push({ card, emoji, index });

            if (flippedCards.length === 2) {
                lockBoard = true;
                const [card1, card2] = flippedCards;
                if (card1.emoji === card2.emoji) {
                    // Match
                    card1.card.classList.add('matched');
                    card2.card.classList.add('matched');
                    matchedPairs++;
                    userScore.stars += 20;
                    userScore.coins += 10;
                    playSound('correct');
                    updateUI();
                    flippedCards = [];
                    lockBoard = false;
                    if (matchedPairs === pairsCount) {
                        showSuccessMessage('ü¶Ñ Toutes les paires trouv√©es !');
                        showConfetti();
                        setTimeout(showMemoryGameMenu, 2000);
                    }
                } else {
                    // No match
                    setTimeout(() => {
                        card1.card.classList.remove('flipped');
                        card2.card.classList.remove('flipped');
                        card1.card.querySelector('span').style.opacity = '0';
                        card2.card.querySelector('span').style.opacity = '0';
                        flippedCards = [];
                        lockBoard = false;
                        userScore.coins = Math.max(0, userScore.coins - 5);
                        playSound('wrong');
                        updateUI();
                    }, 1000);
                }
            }
        }
        btnBack.style.display = 'inline-block';
        btnBack.textContent = 'Retour aux niveaux de m√©moire';
        btnBack.onclick = showMemoryGameMenu;
    }

    function win() {
        content.innerHTML = `<div class="question-prompt">Tu as compl√©t√© toutes les questions! üéâ</div>
                            <div class="prompt ok">Ton score final : ${userScore.stars} √©toiles et ${userScore.coins} pi√®ces.</div>`;
        speakText("Tu as compl√©t√© toutes les questions! F√©licitations pour ton score final.");
        btnBack.style.display = 'inline-block';
        btnBack.textContent = 'Retourner au Menu Principal';
        btnBack.onclick = showTopicMenu;
    }

    // Inicio del juego
    document.addEventListener('DOMContentLoaded', () => {
        initializeQuestions();
        showTopicMenu();
        btnBack.addEventListener('click', showTopicMenu);
    });
  </script>
</body>
</html>
